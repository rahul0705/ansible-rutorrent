---
# tasks file for ansible-rutorrent

- name: "install dependencies"
  become: yes
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - curl
    - gzip
    - unzip
    - unrar
    - mediainfo
  when:
    ansible_os_family == "Debian"
  tags:
    dependacy

- name: "add rtorrent user to apache group"
  become: yes
  user:
    name: "{{ rtorrent_user }}"
    groups: www-data
    append: yes
  tags:
    dependacy

- name: "download rutorrent"
  become: yes
  get_url:
    url: "{{ rutorrent_download_url }}"
    dest: "{{ rutorrent_download_dest }}"
  tags:
    install

- name: "download rutorrent plugins"
  become: yes
  get_url:
    url: "{{ rutorrent_plugins_download_url }}"
    dest: "{{ rutorrent_plugins_download_dest }}"
  tags:
    install

- name: "create rutorrent directory"
  become: yes
  file:
    path: "{{ rutorrent_document_root }}"
    state: directory
    owner: www-data
    group: www-data
  tags:
    install

- name: "install rutorrent"
  become: yes
  unarchive:
    src: "{{ rutorrent_download_dest }}"
    dest: "{{ rutorrent_www_dir }}"
    copy: no
    creates: "{{ rutorrent_document_root }}/conf"
    owner: www-data
    group: www-data
  tags:
    install

- name: "install rutorrent plugins"
  become: yes
  unarchive:
    src: "{{ rutorrent_plugins_download_dest }}"
    dest: "{{ rutorrent_document_root }}"
    copy: no
    creates: "{{ rutorrent_document_root }}/plugins/unpack"
    owner: www-data
    group: www-data
  tags:
    install

- name: "configure rutorrent apache site"
  become: yes
  template:
    src: rtorrent.conf.j2
    dest: /etc/apache2/sites-available/rtorrent.conf
    owner: www-data
    group: www-data
  notify:
    - restart apache
  tags:
    configure

- name: "configure rutorrent htaccess file"
  become: yes
  template:
    src: htaccess.j2
    dest: "{{ rutorrent_document_root }}/.htaccess"
  notify:
    - restart apache
  tags:
    configure

- name: "create rutorrent ssl key folders"
  become: yes
  file:
    path: "{{ rutorrent_ssl_certificate_path }}"
    state: directory
  notify:
    - restart apache
  when:
    - rutorrent_ssl_set
  tags:
    configure

- name: "configure rutorrent ssl site"
  become: yes
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: www-data
    group: www-data
  with_items:
    - { src: "rtorrent.crt.j2", dest: "{{ rutorrent_ssl_certificate_file }}" }
    - { src: "rtorrent.key.j2", dest: "{{ rutorrent_ssl_certificate_key_file }}" }
    - { src: "rtorrent.pem.j2", dest: "{{ rutorrent_ssl_certificate_chain_file }}" }
    - { src: "rtorrent.pem.j2", dest: "{{ rutorrent_ssl_ca_certificate_file }}" }
  notify:
    - restart apache
  when:
    - rutorrent_ssl_set
  tags:
    configure

- name: "enable rutorrent apache site"
  become: yes
  file:
    src: /etc/apache2/sites-available/rtorrent.conf
    dest: /etc/apache2/sites-enabled/rtorrent.conf
    state: link
  notify:
    - restart apache
  tags:
    configure

- name: "configure rutorrent"
  become: yes
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: www-data
    group: www-data
  with_items:
    - { src: "access.ini.j2", dest: "{{ rutorrent_document_root }}/conf/access.ini" }
    - { src: "config.php.j2", dest: "{{ rutorrent_document_root }}/conf/config.php" }
    - { src: "plugins.ini.j2", dest: "{{ rutorrent_document_root }}/conf/plugins.ini" }
  tags:
    configure
